<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>nacos-go 控制台</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:20px;background:#f7f7f7}
    .card{background:#fff;padding:15px 20px;margin-bottom:15px;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    h2{margin-top:0;font-size:18px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:6px 8px;border:1px solid #e6e6e6;text-align:left}
    th{background:#fafafa}
    button{padding:4px 10px;font-size:12px;cursor:pointer}
    input,textarea{padding:4px 6px;font-size:12px;border:1px solid #ccc;border-radius:2px}
    .red{color:#e55}
    .green{color:#393}
  </style>
  <style>
  /* 通知栏核心样式 */
  #notifyBox{position:fixed;top:10px;left:50%;transform:translateX(-50%);
    z-index:9999;font-size:14px;color:#fff;padding:8px 16px;border-radius:4px;
    transition:opacity .3s;opacity:0;pointer-events:none}
  .notify-success{background:#52c41a}
  .notify-error{background:#ff4d4f}
  .notify-info{background:#1890ff}
</style>
</head>
<body>
  <!-- 登录 -->
  <div id="loginCard" class="card">
    <h2>登录</h2>
    <input id="user" placeholder="用户名" value="">
    <input id="pwd" placeholder="密码" type="password" value="">
    <button onclick="login()">登录</button>
  </div>

  <!-- Tenant 管理 -->
  <div class="card" id="tenantCard" style="display:none">
    <h2>Tenant 管理
      <button onclick="loadTenant()" style="float:right">刷新</button>
    </h2>
    <table id="tenantTable">
      <thead><tr><th>Tenant</th><th>操作</th></tr></thead>
      <tbody></tbody>
    </table>
    <div style="margin-top:8px">
      <input id="newTenant" placeholder="新 Tenant 名称"/>
      <button onclick="addTenant()">添加</button>
    </div>
  </div>

  <!-- 服务列表 -->
  <div id="svcCard" class="card" style="display:none">
    <h2>服务实例</h2>
    <table id="svcTable">
      <thead><tr><th>服务名</th><th>分组</th><th>IP:端口</th><th>健康</th><th>操作</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- 配置列表 -->
  <div id="cfgCard" class="card" style="display:none">
    <h2>配置列表</h2>
    <table id="cfgTable">
      <thead><tr><th>DataId</th><th>Group</th><th>内容</th><th>操作</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- 发布配置 -->
  <div class="card" id="pubCard" style="display:none">
    <h2>发布配置</h2>
    <input id="dataId" placeholder="DataId"/><br>
    <input id="groupId" placeholder="Group"/><br>
    <!-- 新增：Tenant 选择 -->
    <select id="tenantSelect">
      <option value="">（空）</option>
    </select><br>
    <textarea id="content" rows="6" cols="60" placeholder="配置内容"></textarea><br>
    <button onclick="publishConfig()">发布</button>
  </div>

  <!-- 登出 -->
  <div id="logoutBar" style="position:fixed;top:5px;right:10px;display:none;">
  <button onclick="logout()">退出登录</button>
  </div>

  <!-- 放一条看不见的通知栏 -->
  <div id="notifyBox"></div>

  <!-- 编辑配置弹层 -->
  <div id="editBox" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:9999">
    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:20px;border-radius:4px;width:420px">
      <h3>编辑配置</h3>
      <input id="editDataId" disabled style="width:100%;margin-bottom:8px"><br>
      <input id="editGroup" disabled style="width:100%;margin-bottom:8px"><br>
      <textarea id="editContent" rows="10" style="width:100%;margin-bottom:12px"></textarea><br>
      <button onclick="saveEdit()">保存</button>
      <button onclick="closeEdit()" style="margin-left:8px">取消</button>
    </div>
  </div>

<script>
const base = '/nacos'; // 同域部署
let token = localStorage.getItem('token') || '';

/* ---------- 登录 ---------- */
async function login(){
  const res = await fetch(base+'/v1/auth/login',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({username: user.value, password: pwd.value})
  }).then(r=>r.json());
  if (!res || res.code != 200 ) {
    notifyError('登录失败:'+res.message);
    return
  }
  if(res.code==200){
    token = res.data.accessToken;
    localStorage.setItem('token', token);
    showCardAndLoadDataStyle();
    notifySuccess('登录成功');
  } else {
    notifyError('登录失败:'+res.message);
  }
}

/* ---------- 服务列表 ---------- */
async function loadSvc(){
  const res = await fetch(base+'/v1/ns/instance/list',{
    headers:{Authorization:'Bearer '+token}
  }).then(r=>r.json());
  let html = '';
  if (!res || res.code != 200 ) {
    notifyError('获取服务列表失败:'+res.message);
    return;
  }
  (res.data || []).forEach(i=>{
    const health = i.healthy ? '<span class=green>健康</span>' : '<span class=red>下线</span>';
    html+=`<tr><td>${i.serviceName}</td><td>${i.groupName}</td><td>${i.ip}:${i.port}</td><td>${health}</td>
           <td><button onclick=deregister('${i.ip}',${i.port})>下线</button></td></tr>`;
  });
  svcTable.tBodies[0].innerHTML = html || '<tr><td colspan=5>暂无实例</td></tr>';
}

/* 下线实例 */
async function deregister(ip, port){
  const res = await fetch(base+`/v1/ns/instance?ip=${ip}&port=${port}`,{
    method:'DELETE',
    headers:{Authorization:'Bearer '+token}
  }).then(r=>r.json());
  if (!res || res.code != 200 ) {
    notifyError('下线失败');
    return
  }
  if (res.code == 200) {
    notifySuccess('下线成功');
    loadSvc();
  } else {  
    notifyError('下线失败:'+res.message);
  }
}

/* ========== Tenant ========== */
let tenantList = []; // 缓存

/* 加载全部 Tenant */
async function loadTenant(){
    const res = await fetch(base+'/v1/cs/tenants', {headers:{Authorization:'Bearer '+token}}).then(r=>r.json());
    if (!res || res.code != 200 ) {
      notifyError('加载 Tenant 失败');
      return
    }
    if (res.code == 200) {
      tenantList = res.data
      // 刷新 Tenant 表
      let html = '';
      tenantList.forEach(t => html += `<tr><td>${t}</td><td><button onclick="delTenant('${t}')">删除</button></td></tr>`);
      document.querySelector('#tenantTable tbody').innerHTML = html || '<tr><td colspan="2">暂无 Tenant</td></tr>';
      // 同步下拉框
      refreshTenantSelect();
    } else {
      notifyError('加载 Tenant 失败:'+res.message);
    }
}

  /* 添加 Tenant */
  async function addTenant(){
    const t = document.getElementById('newTenant').value.trim();
    if (!t) { notifyError('名称不能为空'); return; }
    const res = await fetch(base+'/v1/cs/tenants', 
    {
      method:'POST',
      headers:{Authorization:'Bearer '+token},
      body:JSON.stringify({tenant:t})
    }).then(res=>res.json());
    if (!res || res.code != 200 ) {
      notifyError('添加 Tenant 失败');
      return
    }
    if (res.code == 200) {
      document.getElementById('newTenant').value = '';
      notifySuccess('添加成功');
      loadTenant();
    } else {
      notifyError('添加 Tenant 失败:'+res.message);
    }
  }

  /* 删除 Tenant */
  async function delTenant(tenant){
    if (!confirm(`确认删除 Tenant：${tenant} ？`)) return;
    const res = await fetch(base+'/v1/cs/tenants?tenant='+tenant, 
    {
      method:'DELETE',
      headers:{Authorization:'Bearer '+token}
    }).then(res=>res.json());
    if (!res || res.code != 200 ) {
      notifyError('删除 Tenant 失败');
      return
    }
    if (res.code==200) {
      notifySuccess('删除成功');
      loadTenant();
    } else {
      notifyError('删除 Tenant 失败:'+res.message);
    }
  }

  /* 同步下拉框选项 */
  function refreshTenantSelect(){
    const html = tenantList.map(t => `<option value="${t}">${t}</option>`).join('');
    // 发布框
    const pubSel = document.getElementById('tenantSelect');
    pubSel.innerHTML = !html?'<option value="">（空）</option>':html;
    // 编辑框
    const editSel = document.getElementById('editTenant');
    if (editSel) editSel.innerHTML = !html?'<option value="">（空）</option>':html;
  }

/* ---------- 配置列表 ---------- */
async function loadCfg(){
  const res = await fetch(base+'/v1/cs/configs/list',{
    headers:{Authorization:'Bearer '+token}
  }).then(r=>r.json());
  if (!res || res.code != 200 ) {
    notifyError('获取配置列表失败:'+res.message);
    return;
  }
  let html = '';
  (res.data || []).forEach(c=>{
    html+=`<tr><td>${c.dataId}</td><td>${c.group}</td><td><pre>${c.content}</pre></td>
            <td>
              <button onclick="openEdit('${c.dataId}','${c.group}', \`${c.content.replace(/`/g, '\\`')}\`,'${c.tenant}')">编辑</button>
              <button onclick="delCfg('${c.dataId}','${c.group}','${c.tenant}')">删除</button>
            </td>
           </tr>`;
  });
  cfgTable.tBodies[0].innerHTML = html || '<tr><td colspan=4>暂无配置</td></tr>';
}

/* 删除配置 */
async function delCfg(dataId, group, tenantId){
  if (!confirm(`确认删除 config ${dataId}+'-'+${group}+'-'${tenantId} ？`)) return;
  const res = await fetch(base+`/v1/cs/configs?dataId=${dataId}&group=${group}&tenantId=${tenantId}`,{
    method:'DELETE',
    headers:{Authorization:'Bearer '+token}
  }).then(r=>r.json());
  if (!res || res.code != 200 ) {
    notifyError('删除配置失败');
    return
  }
  if (res.code == 200) {
      notifySuccess("删除配置成功")
      loadCfg();
  } else {
    notifyError("删除配置失败:"+res.message)
  }
}

/* ===== 编辑相关 ===== */
let gEdit = {}; // 临时存当前项

function openEdit(dataId, group, content,tenant) {
  gEdit = { dataId, group, content ,tenant};
  document.getElementById('editDataId').value = dataId;
  document.getElementById('editGroup').value = group;
  document.getElementById('editContent').value = content;
  document.getElementById('editBox').style.display = 'block';
}

function closeEdit() {
  document.getElementById('editBox').style.display = 'none';
}

async function saveEdit() {
  const dataId = gEdit.dataId,
        group = gEdit.group,
        tenant = gEdit.tenant,
        content = document.getElementById('editContent').value.trim();
  if (!content) { notifyError('内容不能为空'); return; }
    const res = await fetch(base+'/v1/cs/configs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
      body: JSON.stringify({ dataId, group, content,tenant })
    }).then(res => res.json());
    if (!res || res.code != 200 ) {
      notifyError('保存失败');
      return
    }
    if (res.code==200) {
      notifySuccess('保存成功');
      closeEdit();
      loadCfg(); // 刷新列表
    } else { notifyError('保存失败'); }
}

// 清空dataId groupId div
async function clearInput(){
    dataId.value = ''
    groupId.value = ''
    content.value = ''
}


/* ---------- 发布配置 ---------- */
async function publishConfig(){
  const body = {
    dataId: dataId.value.trim(),
    group: groupId.value.trim(),
    content: content.value.trim(),
    tenant: document.getElementById('tenantSelect').value.trim()
  };
  if(!body.dataId || !body.group || !body.content || !body.tenant){
    notifyError('请填写完整')
    return
  }
  const res = await fetch(base+'/v1/cs/configs',{
    method:'POST',
    headers:{'Content-Type':'application/json', Authorization:'Bearer '+token},
    body:JSON.stringify(body)
  }).then(r=>r.json());
  if (!res || res.code != 200 ) {
    notifyError('发布失败');
    return
  }
  if(res.code == 200){ 
    notifySuccess('发布成功'); 
    clearInput();
    loadCfg(); 
  } else {
    notifyError('发布失败:'+res.message);
  }
}
/* ===== 新增：退出登录 ===== */
async function logout(){
  notifySuccess('退出登录成功');
  localStorage.removeItem('token');
  location.reload();   // 回到登录页
  return;
}

/* === 三色通知 === */
function notify(msg, type = 'info', duration = 2500) {
  const box = document.getElementById('notifyBox');
  box.textContent = msg;
  box.className = 'notify-' + type;   // 换颜色
  box.style.opacity = '1';
  setTimeout(() => box.style.opacity = '0', duration);
}

function showCardAndLoadDataStyle() {
    loginCard.style.display='none';
    tenantCard.style.display='block';
    svcCard.style.display='block';
    cfgCard.style.display='block';
    pubCard.style.display='block';
    document.getElementById('logoutBar').style.display='block'; // ★ 显示退出
    loadSvc(); 
    loadCfg();
    loadTenant();
}

/* 快捷函数 */
const notifySuccess = (msg, t) => notify(msg, 'success', t);
const notifyError   = (msg, t) => notify(msg, 'error', t);
const notifyInfo    = (msg, t) => notify(msg, 'info', t);


/* ---------- 页面加载 ---------- */
/* 登录成功后把退出按钮显示出来 */
window.onload = () => {
  if(token){
    showCardAndLoadDataStyle();
  }
};
</script>
</body>
</html>